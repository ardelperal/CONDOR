Attribute VB_Name = "modTestRunner"
Option Compare Database
Option Explicit


' ============================================================================
' ¡¡¡ REQUISITO DE COMPILACIÓN CRÍTICO !!!
' Este módulo utiliza el descubrimiento automático de pruebas a través del objeto
' Application.VBE. Para que el proyecto compile, es OBLIGATORIO tener
' activada la referencia a la librería:
' "Microsoft Visual Basic for Applications Extensibility 5.3"
' (Herramientas -> Referencias -> Marcar la casilla correspondiente)
' Si esta referencia falta, el proyecto NO COMPILARÁ.
' ============================================================================


' NOTA: Variable de estado global eliminada para hacer el motor sin estado
' Private m_SuiteNames As Scripting.Dictionary <- ELIMINADA

' Función para compatibilidad con CLI (debe estar fuera del bloque condicional)
Public Function RunAllTests() As String
    On Error GoTo ErrorHandler
    
    ' 1. Crear una configuración específica para esta ejecución de pruebas
    Dim testConfig As New CMockConfig
    testConfig.SetSetting "LOG_FILE_PATH", CurrentProject.Path & "\condor_test_run.log"
    
    ' 2. Crear el ErrorHandler para el PROPIO RUNNER, inyectándole la config de prueba
    Dim errorHandler As IErrorHandlerService
    Set errorHandler = modErrorHandlerFactory.CreateErrorHandlerService(testConfig)
    
    ' El flujo sin estado:
    Dim suiteNames As Scripting.Dictionary
    Set suiteNames = DiscoverAndRegisterSuites() ' 1. Descubrir
    
    Dim reporter As ITestReporter
    Dim reporterImpl As New CTestReporter
    Set reporter = reporterImpl
    
    Dim allResults As Scripting.Dictionary
    Set allResults = ExecuteAllSuites(suiteNames) ' 2. Ejecutar pasando las suites
    
    reporter.Initialize allResults
    
    Dim reportString As String
    reportString = reporter.GenerateReport()
    
    RunAllTests = reportString
    Exit Function
    
ErrorHandler:
    If Not errorHandler Is Nothing Then
        errorHandler.LogError Err.Number, Err.Description, "modTestRunner.RunAllTests", True
    End If
    RunAllTests = "FALLO CRÍTICO EN EL MOTOR DE PRUEBAS: " & Err.Description & vbCrLf & "RESULT: FAILED"
End Function

' Función para registrar suites manualmente (sin dependencia de VBE)
' Usada por ExecuteAllTestsForCLI para evitar problemas con referencias externas
Private Function RegisterSuitesManually() As Scripting.Dictionary
    On Error Resume Next
    
    Dim suites As New Scripting.Dictionary
    suites.CompareMode = TextCompare
    
    ' Registrar todas las suites de prueba conocidas manualmente
    ' Esto evita la dependencia de Application.VBE que puede fallar desde CLI
    
    ' Suites de prueba unitaria
    suites.Add "TestModAssert.RunAll", "TestModAssert.RunAll"
    suites.Add "TestSolicitudService.RunAll", "TestSolicitudService.RunAll"
    
    ' Suites de prueba de integración
    suites.Add "TIDocumentService.RunAll", "TIDocumentService.RunAll"
    suites.Add "TIExpedienteRepository.RunAll", "TIExpedienteRepository.RunAll"
    suites.Add "TIMapeoRepository.RunAll", "TIMapeoRepository.RunAll"
    suites.Add "TINotificationService.RunAll", "TINotificationService.RunAll"
    suites.Add "TIOperationRepository.RunAll", "TIOperationRepository.RunAll"
    suites.Add "TISolicitudRepository.RunAll", "TISolicitudRepository.RunAll"
    
    Set RegisterSuitesManually = suites
    On Error GoTo 0
End Function


' Alias para compatibilidad con CLI
Public Function ExecuteAllTests() As String
    ExecuteAllTests = RunAllTests()
End Function

' Función específica para CLI - Sin MsgBox, manejo robusto de errores
Public Function ExecuteAllTestsForCLI() As String
    On Error GoTo ErrorHandler
    
    ' 0. Configurar Access en modo completamente silencioso
    On Error Resume Next
    Application.Echo False
    DoCmd.Echo False
    DoCmd.SetWarnings False
    Err.Clear
    On Error GoTo ErrorHandler
    
    ' 1. Crear una configuración específica para esta ejecución de pruebas
    Dim testConfig As New CMockConfig
    testConfig.SetSetting "LOG_FILE_PATH", CurrentProject.Path & "\condor_test_run.log"
    
    ' 2. Crear el ErrorHandler para el PROPIO RUNNER, inyectándole la config de prueba
    Dim errorHandler As IErrorHandlerService
    Set errorHandler = modErrorHandlerFactory.CreateErrorHandlerService(testConfig)

    ' El flujo sin estado:
    Dim suiteNames As Scripting.Dictionary
    Set suiteNames = RegisterSuitesManually() ' 1. Registrar suites manualmente

    Dim reporter As ITestReporter
    Dim reporterImpl As New CTestReporter
    Set reporter = reporterImpl

    Dim allResults As Scripting.Dictionary
    Set allResults = ExecuteAllSuites(suiteNames) ' 2. Ejecutar pasando las suites

    reporter.Initialize allResults

    Dim reportString As String
    reportString = reporter.GenerateReport()

    ' Verificar si todas las pruebas pasaron
    Dim allPassed As Boolean
    allPassed = True

    Dim suiteResult As CTestSuiteResult
    Dim key As Variant
    For Each key In allResults.Keys()
        Set suiteResult = allResults(key)
        If Not suiteResult.AllTestsPassed Then
            allPassed = False
            Exit For
        End If
    Next

    ' Añadir línea de resultado final
    If allPassed Then
        reportString = reportString & vbCrLf & "RESULT: SUCCESS"
    Else
        reportString = reportString & vbCrLf & "RESULT: FAILURE"
    End If

    ExecuteAllTestsForCLI = reportString
    Exit Function

ErrorHandler:
    If Not errorHandler Is Nothing Then
        errorHandler.LogError Err.Number, Err.Description, "modTestRunner.ExecuteAllTestsForCLI", True
    End If

    ExecuteAllTestsForCLI = "FALLO CRÍTICO EN EL MOTOR DE PRUEBAS CLI: " & Err.Description & vbCrLf & "RESULT: FAILURE"
End Function

'******************************************************************************
' MOTOR DE EJECUCIÓN DE PRUEBAS - FRAMEWORK ORIENTADO A OBJETOS
' Arquitectura: Separación de Responsabilidades (Ejecución vs. Reporte)
' Version: 3.0 - Refactorización Crítica
'******************************************************************************

'******************************************************************************
' FUNCIÓN PRINCIPAL - ORQUESTADOR DEL FRAMEWORK
'******************************************************************************

' Función principal que orquesta todo el proceso: registrar, ejecutar y reportar
Public Sub RunTestFramework()
    On Error GoTo errorHandler
    
    ' Obtener instancia del manejador de errores
    Dim errorHandler As IErrorHandlerService
    Set errorHandler = modErrorHandlerFactory.CreateErrorHandlerService()
    
    ' El flujo sin estado:
    Dim suiteNames As Scripting.Dictionary
    Set suiteNames = DiscoverAndRegisterSuites() ' 1. Descubrir
    
    ' 1. EJECUTAR
    Dim allResults As Scripting.Dictionary
    Set allResults = ExecuteAllSuites(suiteNames) ' 2. Ejecutar pasando las suites
    
    ' 2. GENERAR REPORTE (Responsabilidad de CTestReporter)
    Dim reporter As New CTestReporter
    reporter.Initialize allResults
    Dim reportString As String
    reportString = reporter.GenerateReport()
    
    ' 3. PRESENTAR (Responsabilidad del Runner/UI)
    MsgBox reportString, vbInformation, "Resultados de Pruebas CONDOR"
    
    Exit Sub
    
errorHandler:
    errorHandler.LogError Err.Number, Err.Description, "modTestRunner.RunTestFramework", True
End Sub


'******************************************************************************
' GESTIÓN DE DESCUBRIMIENTO AUTOMÁTICO DE SUITES
'******************************************************************************

Private Function DiscoverAndRegisterSuites() As Scripting.Dictionary
    On Error GoTo ErrorHandler
    
    Dim suites As New Scripting.Dictionary
    suites.CompareMode = TextCompare
    
    Dim vbProject As Object
    Set vbProject = Application.VBE.ActiveVBProject
    
    Dim vbComponent As Object
    For Each vbComponent In vbProject.VBComponents
        If vbComponent.Type = 1 Then
            Dim componentName As String
            componentName = vbComponent.Name
            
            If LCase(Left(componentName, 4)) = "test" Or LCase(Left(componentName, 2)) = "ti" Then
                Dim suiteFunction As String
                suiteFunction = componentName & "RunAll"
                suites.Add suiteFunction, suiteFunction
            End If
        End If
    Next vbComponent
    
    Set DiscoverAndRegisterSuites = suites
    Exit Function
    
ErrorHandler:
    Dim errorHandler As IErrorHandlerService
    Set errorHandler = modErrorHandlerFactory.CreateErrorHandlerService()
    errorHandler.LogError Err.Number, Err.Description, "modTestRunner.DiscoverAndRegisterSuites", True
    Err.Raise Err.Number, "modTestRunner.DiscoverAndRegisterSuites", "FALLO CRÍTICO: " & Err.Description
End Function




'******************************************************************************
' MOTOR DE EJECUCIÓN
'******************************************************************************

' Función que ejecuta todas las suites registradas y devuelve resultados
Private Function ExecuteAllSuites(ByVal suiteNames As Scripting.Dictionary) As Scripting.Dictionary
    Dim allResults As New Scripting.Dictionary
    allResults.CompareMode = TextCompare
    Dim i As Integer
    
    Dim suiteKeys As Variant
    suiteKeys = suiteNames.Keys()
    
    For i = 0 To UBound(suiteKeys)
        Dim suiteName As String
        suiteName = suiteKeys(i)
        
        ' Ejecutar la suite usando Application.Run
        On Error Resume Next
        Dim suiteResult As CTestSuiteResult
        Set suiteResult = Application.Run(suiteName)
        
        If Err.Number = 0 And Not suiteResult Is Nothing Then
            allResults.Add suiteName, suiteResult
        Else
            ' Crear un resultado de error para suites que fallan
            Dim errorSuite As New CTestSuiteResult
            Call errorSuite.Initialize(suiteName)
            
            Dim errorTest As New CTestResult
            Call errorTest.Initialize("Suite_Execution_Error")
            Call errorTest.Fail("Error ejecutando suite: " & Err.Description)
            
            Call errorSuite.AddResult(errorTest)
            allResults.Add suiteName, errorSuite
            
            ' Log the error
            Dim localErrorHandler As IErrorHandlerService
            Set localErrorHandler = modErrorHandlerFactory.CreateErrorHandlerService()
            localErrorHandler.LogError Err.Number, Err.Description, "modTestRunner.ExecuteAllSuites", True ' Mark as critical
        End If
        
        On Error GoTo 0
    Next i
    
    Set ExecuteAllSuites = allResults
End Function

'******************************************************************************
' FUNCIÓN DE COMPATIBILIDAD PARA EJECUCIÓN MANUAL
'******************************************************************************

' Función de compatibilidad para ejecución manual desde modAppManager
Public Sub EjecutarTodasLasPruebas()
    Call RunTestFramework
End Sub














